<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RialoSwap â€” Solana DEX</title>
<meta name="description" content="RialoSwap â€” The fastest Solana DEX aggregator">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>

<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#060b12;--card:#0d1520;--border:rgba(0,220,180,0.12);
  --accent:#00dcb4;--accent2:#00ffe0;--red:#ff4560;
  --text:#dff0ec;--muted:rgba(200,230,220,0.4);
  --font:'Syne',sans-serif;--mono:'DM Mono',monospace;
}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:linear-gradient(rgba(0,220,180,0.04) 1px,transparent 1px),
  linear-gradient(90deg,rgba(0,220,180,0.04) 1px,transparent 1px);
  background-size:42px 42px}

/* â”€â”€ NAV â”€â”€ */
nav{position:sticky;top:0;z-index:300;display:flex;align-items:center;
  justify-content:space-between;padding:0 20px;height:60px;
  background:rgba(6,11,18,0.98);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border)}
.logo{font-size:1.3rem;font-weight:800;letter-spacing:1px;
  background:linear-gradient(120deg,var(--accent2),var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo small{-webkit-text-fill-color:rgba(255,255,255,0.3);font-weight:400}
.navlinks{display:flex;gap:24px}
.navlinks a{color:var(--muted);font-size:0.72rem;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;cursor:pointer;text-decoration:none;transition:color .2s}
.navlinks a:hover,.navlinks a.on{color:var(--accent)}
.navr{display:flex;align-items:center;gap:8px}
.nbadge{display:flex;align-items:center;gap:5px;padding:4px 11px;border-radius:20px;
  background:rgba(0,220,180,0.07);border:1px solid rgba(0,220,180,0.18);
  font-size:0.64rem;font-weight:700;color:var(--accent);font-family:var(--mono)}
.ndot{width:6px;height:6px;border-radius:50%;background:var(--accent);
  box-shadow:0 0 6px var(--accent);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
#cwBtn{padding:8px 18px;border-radius:7px;
  background:linear-gradient(135deg,var(--accent),#00a88a);
  border:none;color:#05100a;font-family:var(--font);font-size:0.74rem;
  font-weight:800;letter-spacing:1px;cursor:pointer;transition:.2s;white-space:nowrap}
#cwBtn:hover{box-shadow:0 0 18px rgba(0,220,180,0.4);transform:translateY(-1px)}
#cwBtn.connected{background:rgba(0,220,180,0.1);border:1px solid var(--accent);color:var(--accent)}

/* â”€â”€ LAYOUT â”€â”€ */
main{position:relative;z-index:1;max-width:1340px;margin:0 auto;padding:14px 16px;
  display:grid;grid-template-columns:175px 1fr 355px;gap:12px}

/* â”€â”€ PANELS â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.ch{padding:10px 14px;border-bottom:1px solid var(--border);font-size:0.62rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:flex;align-items:center;gap:7px}
.ch::before{content:'';width:3px;height:10px;background:var(--accent);border-radius:2px}

/* â”€â”€ PAIR LIST â”€â”€ */
.tpairs{grid-row:1/4}
.titem{display:flex;align-items:center;gap:7px;padding:9px 10px;cursor:pointer;
  border-bottom:1px solid rgba(0,220,180,0.04);transition:.15s}
.titem:hover{background:rgba(0,220,180,0.05)}
.titem.on{background:rgba(0,220,180,0.09);border-left:2px solid var(--accent)}
.titem .coin-icon{width:26px;height:26px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:14px;
  background:rgba(255,255,255,0.06)}
.tii{flex:1;min-width:0}
.tis{font-size:0.7rem;font-weight:700}
.tip{font-size:0.64rem;font-weight:600;font-family:var(--mono);margin-top:1px}
.tic{font-size:0.56rem;font-family:var(--mono)}
.g{color:var(--accent)}.rr{color:var(--red)}

/* â”€â”€ CENTER â”€â”€ */
.center{display:flex;flex-direction:column;gap:12px}
.cchart{display:flex;flex-direction:column}
.ctop{display:flex;align-items:center;gap:12px;padding:12px 16px;
  border-bottom:1px solid var(--border);flex-wrap:wrap}
.plogos{position:relative;width:50px;height:30px;flex-shrink:0}
.plogos .coin-icon{width:30px;height:30px;border-radius:50%;position:absolute;
  display:flex;align-items:center;justify-content:center;font-size:16px;
  border:2px solid var(--bg);background:rgba(255,255,255,0.06)}
.plogos .coin-icon:first-child{left:0;z-index:2}
.plogos .coin-icon:last-child{left:20px;z-index:1}
.pnm{font-size:0.95rem;font-weight:800;letter-spacing:1px}
.ppw{flex:1}
.lp{font-size:1.5rem;font-weight:800;font-family:var(--mono);color:var(--accent2)}
.lc{font-size:0.7rem;font-family:var(--mono);margin-left:7px}
.tfs{display:flex;gap:3px}
.tf{padding:4px 8px;border-radius:5px;background:transparent;
  border:1px solid rgba(0,220,180,0.13);color:var(--muted);font-family:var(--font);
  font-size:0.64rem;font-weight:700;cursor:pointer;transition:.15s}
.tf:hover,.tf.on{background:rgba(0,220,180,0.1);border-color:var(--accent);color:var(--accent)}
#chartDiv{height:290px;width:100%}
.inds{display:flex;gap:20px;padding:9px 16px;border-top:1px solid var(--border);flex-wrap:wrap}
.ind{font-size:0.66rem;font-family:var(--mono)}
.ind-l{color:var(--muted)}
.ind-v{font-weight:600;margin-left:4px}

/* â”€â”€ STATS â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:13px 15px}
.sl{font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.sv{font-size:1.05rem;font-weight:800;font-family:var(--mono);color:var(--accent2)}
.ss{font-size:0.62rem;font-family:var(--mono);color:var(--muted);margin-top:2px}

/* â”€â”€ TRADES â”€â”€ */
.tcols{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;padding:6px 14px;
  font-size:0.58rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--muted);border-bottom:1px solid rgba(0,220,180,0.05)}
.trow{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;padding:6px 14px;
  font-size:0.68rem;font-family:var(--mono);border-bottom:1px solid rgba(0,220,180,0.03);
  animation:fin .3s ease}
@keyframes fin{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:none}}

/* â”€â”€ RIGHT / SWAP â”€â”€ */
.right{display:flex;flex-direction:column;gap:12px}
.swapcard{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.swap-header{padding:12px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between}
.swap-title{font-size:0.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--muted);display:flex;align-items:center;gap:7px}
.swap-title::before{content:'';width:3px;height:10px;background:var(--accent);border-radius:2px}
.slip-btn-sm{font-size:0.6rem;font-family:var(--mono);color:var(--muted);
  background:rgba(0,220,180,0.06);border:1px solid var(--border);border-radius:5px;
  padding:3px 8px;cursor:pointer;transition:.2s}
.slip-btn-sm:hover{color:var(--accent);border-color:var(--accent)}
.swap-body{padding:14px}

/* token box */
.tbox{background:rgba(255,255,255,0.03);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;margin-bottom:8px;transition:.2s}
.tbox:focus-within{border-color:rgba(0,220,180,0.3)}
.tbox-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.tbox-lbl{font-size:0.58rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
.tbox-bal{font-size:0.6rem;font-family:var(--mono);color:var(--muted);cursor:pointer;transition:.15s}
.tbox-bal:hover{color:var(--accent)}
.tbox-row{display:flex;align-items:center;gap:10px}
.tk-sel{display:flex;align-items:center;gap:7px;background:rgba(0,220,180,0.08);
  border:1px solid rgba(0,220,180,0.2);border-radius:8px;padding:7px 10px;
  cursor:pointer;transition:.2s;white-space:nowrap;min-width:100px}
.tk-sel:hover{background:rgba(0,220,180,0.14);border-color:var(--accent)}
.tk-icon{width:22px;height:22px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:13px;
  background:rgba(255,255,255,0.08)}
.tk-sym{font-size:0.82rem;font-weight:800}
.tk-chev{margin-left:auto;color:var(--muted);font-size:0.65rem}
.amt-inp{flex:1;background:transparent;border:none;color:var(--text);
  font-family:var(--mono);font-size:1.15rem;font-weight:700;
  outline:none;text-align:right;min-width:0}
.amt-inp::placeholder{color:rgba(200,230,220,0.15)}
.amt-usd{text-align:right;font-size:0.6rem;font-family:var(--mono);color:var(--muted);margin-top:4px}

/* flip */
.flip-wrap{display:flex;justify-content:center;margin:2px 0}
.flip-btn{width:34px;height:34px;border-radius:50%;background:var(--card);
  border:2px solid var(--border);display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:.3s;font-size:1.1rem;user-select:none}
.flip-btn:hover{border-color:var(--accent);background:rgba(0,220,180,0.1);transform:rotate(180deg)}

/* route */
.route-box{background:rgba(0,220,180,0.03);border:1px solid rgba(0,220,180,0.08);
  border-radius:9px;padding:10px 13px;margin-bottom:12px;display:none}
.route-row{display:flex;justify-content:space-between;align-items:center;
  padding:3px 0;font-size:0.63rem;font-family:var(--mono)}
.rl{color:var(--muted)}
.rv{color:var(--text);font-weight:600}
.rv.g{color:var(--accent)}.rv.w{color:#f0a500}.rv.r{color:var(--red)}
.rpath{display:flex;align-items:center;gap:3px;flex-wrap:wrap}
.hop{background:rgba(0,220,180,0.08);border:1px solid rgba(0,220,180,0.15);
  border-radius:4px;padding:2px 6px;font-size:0.55rem;font-weight:700}

/* swap button */
.swap-btn{width:100%;padding:15px;border-radius:10px;border:none;
  font-family:var(--font);font-size:0.85rem;font-weight:800;letter-spacing:2px;
  text-transform:uppercase;cursor:pointer;transition:.25s;margin-top:4px}
.swap-btn.s-connect{background:linear-gradient(135deg,var(--accent),#009e8a);color:#04120e}
.swap-btn.s-connect:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,220,180,0.35)}
.swap-btn.s-enter{background:rgba(255,255,255,0.05);color:var(--muted);cursor:not-allowed}
.swap-btn.s-loading{background:rgba(0,220,180,0.08);color:var(--accent);
  border:1px solid rgba(0,220,180,0.3);cursor:not-allowed}
.swap-btn.s-ready{background:linear-gradient(135deg,var(--accent),#009e8a);color:#04120e}
.swap-btn.s-ready:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,220,180,0.35)}
.swap-btn.s-err{background:rgba(255,69,96,0.1);color:var(--red);
  border:1px solid rgba(255,69,96,0.25);cursor:not-allowed}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{display:inline-block;width:13px;height:13px;border:2px solid currentColor;
  border-top-color:transparent;border-radius:50%;animation:spin .7s linear infinite;
  vertical-align:middle;margin-right:6px}

/* â”€â”€ MODALS â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.82);z-index:800;
  display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px)}
.overlay.show{display:flex}

/* Wallet modal */
.wmodal-box{background:#0e1a2a;border:1px solid var(--border);border-radius:16px;
  padding:28px;width:340px;max-width:92vw}
.wmodal-title{font-size:1.05rem;font-weight:800;margin-bottom:6px}
.wmodal-sub{font-size:0.7rem;color:var(--muted);margin-bottom:18px}
.w-opt{display:flex;align-items:center;gap:14px;padding:13px 15px;border-radius:10px;
  border:1px solid var(--border);background:rgba(255,255,255,0.03);
  cursor:pointer;margin-bottom:9px;transition:.2s;position:relative}
.w-opt:hover{background:rgba(0,220,180,0.07);border-color:rgba(0,220,180,0.35);transform:translateX(2px)}
.w-icon{width:40px;height:40px;border-radius:10px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:22px}
.w-icon.phantom {background:linear-gradient(135deg,#534bb1,#551bf9)}
.w-icon.solflare{background:linear-gradient(135deg,#ff6a00,#fc7227)}
.w-icon.backpack{background:linear-gradient(135deg,#e33d3d,#8b0000)}
.w-icon.trust   {background:linear-gradient(135deg,#3375bb,#1a5fa8)}
.w-name{font-size:0.85rem;font-weight:700}
.w-desc{font-size:0.62rem;color:var(--muted);margin-top:2px}
.w-status{position:absolute;right:14px;top:50%;transform:translateY(-50%);
  font-size:0.58rem;font-family:var(--mono);color:var(--accent);
  background:rgba(0,220,180,0.1);border:1px solid rgba(0,220,180,0.2);
  border-radius:4px;padding:2px 6px}
.w-status.na{color:var(--muted);background:rgba(200,230,220,0.05);border-color:rgba(200,230,220,0.1)}
.w-cancel{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);
  background:transparent;color:var(--muted);font-family:var(--font);
  font-size:0.72rem;cursor:pointer;margin-top:4px;transition:.2s}
.w-cancel:hover{border-color:var(--accent);color:var(--accent)}

/* Slippage modal */
.smodal-box{background:#0e1a2a;border:1px solid var(--border);border-radius:12px;padding:22px;width:290px}
.smodal-title{font-size:0.85rem;font-weight:800;margin-bottom:12px}
.s-opts{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px}
.s-opt{padding:9px;border-radius:6px;border:1px solid var(--border);
  background:transparent;color:var(--muted);font-family:var(--mono);
  font-size:0.7rem;cursor:pointer;transition:.15s;text-align:center}
.s-opt:hover,.s-opt.on{background:rgba(0,220,180,0.1);border-color:var(--accent);color:var(--accent)}
.s-inp{width:100%;padding:9px 12px;background:rgba(255,255,255,0.04);
  border:1px solid var(--border);border-radius:7px;color:var(--text);
  font-family:var(--mono);font-size:0.8rem;outline:none;margin-bottom:10px}
.s-done{width:100%;padding:9px;border-radius:7px;border:1px solid var(--accent);
  background:rgba(0,220,180,0.08);color:var(--accent);font-family:var(--font);
  font-size:0.72rem;cursor:pointer;transition:.2s}
.s-done:hover{background:rgba(0,220,180,0.15)}

/* Token picker modal */
.tkmodal-box{background:#0e1a2a;border:1px solid var(--border);border-radius:14px;
  width:350px;max-height:520px;overflow:hidden;display:flex;flex-direction:column}
.tksearch{padding:14px;border-bottom:1px solid var(--border)}
.tksearch-title{font-size:0.78rem;font-weight:800;margin-bottom:10px}
.tkinp{width:100%;padding:10px 13px;background:rgba(255,255,255,0.04);
  border:1px solid var(--border);border-radius:8px;color:var(--text);
  font-family:var(--mono);font-size:0.82rem;outline:none}
.tkinp:focus{border-color:rgba(0,220,180,0.3)}
.tklist{overflow-y:auto;flex:1;padding:8px}
.tklist::-webkit-scrollbar{width:3px}
.tklist::-webkit-scrollbar-thumb{background:rgba(0,220,180,0.2);border-radius:2px}
.tkitem{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;
  cursor:pointer;transition:.15s}
.tkitem:hover{background:rgba(0,220,180,0.06)}
.tkitem.sel{background:rgba(0,220,180,0.1)}
.tkitem .tk-icon{width:32px;height:32px;font-size:17px;flex-shrink:0}
.tkitem-sym{font-size:0.8rem;font-weight:800}
.tkitem-name{font-size:0.62rem;color:var(--muted);margin-top:1px}

/* Toast */
.toast{position:fixed;bottom:22px;right:22px;z-index:900;
  background:#0e1a2a;border:1px solid var(--accent);border-radius:9px;
  padding:12px 16px;font-size:0.76rem;line-height:1.5;
  transform:translateY(70px);opacity:0;transition:.3s;max-width:290px;pointer-events:none}
.toast.show{transform:none;opacity:1}
.toast.err{border-color:var(--red)}

footer{position:relative;z-index:1;text-align:center;padding:18px;
  font-size:0.63rem;color:var(--muted);border-top:1px solid var(--border);letter-spacing:1px}
footer b{color:var(--accent)}

@media(max-width:960px){
  main{grid-template-columns:1fr}
  .tpairs{display:none}
  .stats{grid-template-columns:repeat(2,1fr)}
  .navlinks{display:none}
}
</style>
</head>
<body>

<!-- â•â• WALLET MODAL â•â• -->
<div class="overlay" id="wModal">
  <div class="wmodal-box">
    <div class="wmodal-title">Connect Wallet</div>
    <div class="wmodal-sub">Choose your Solana wallet to start swapping</div>

    <div class="w-opt" id="phantomOpt" onclick="doConnect('phantom')">
      <div class="w-icon phantom">ğŸ‘»</div>
      <div>
        <div class="w-name">Phantom</div>
        <div class="w-desc">Most popular Solana wallet</div>
      </div>
      <span class="w-status" id="phantomStatus">Detecting...</span>
    </div>

    <div class="w-opt" id="solflareOpt" onclick="doConnect('solflare')">
      <div class="w-icon solflare">ğŸ”¥</div>
      <div>
        <div class="w-name">Solflare</div>
        <div class="w-desc">Non-custodial Solana wallet</div>
      </div>
      <span class="w-status" id="solflareStatus">Detecting...</span>
    </div>

    <div class="w-opt" id="backpackOpt" onclick="doConnect('backpack')">
      <div class="w-icon backpack">ğŸ’</div>
      <div>
        <div class="w-name">Backpack</div>
        <div class="w-desc">Multi-chain xNFT wallet</div>
      </div>
      <span class="w-status" id="backpackStatus">Detecting...</span>
    </div>

    <div class="w-opt" onclick="doConnect('trust')">
      <div class="w-icon trust">ğŸ›¡ï¸</div>
      <div>
        <div class="w-name">Trust Wallet</div>
        <div class="w-desc">Mobile-first wallet</div>
      </div>
      <span class="w-status" id="trustStatus">Detecting...</span>
    </div>

    <button class="w-cancel" onclick="closeModal('wModal')">Cancel</button>
  </div>
</div>

<!-- â•â• SLIPPAGE MODAL â•â• -->
<div class="overlay" id="sModal">
  <div class="smodal-box">
    <div class="smodal-title">âš™ Slippage Tolerance</div>
    <div class="s-opts">
      <button class="s-opt" onclick="setSlip(0.1,this)">0.1%</button>
      <button class="s-opt on" onclick="setSlip(0.5,this)">0.5%</button>
      <button class="s-opt" onclick="setSlip(1,this)">1%</button>
      <button class="s-opt" onclick="setSlip(3,this)">3%</button>
    </div>
    <input class="s-inp" type="number" placeholder="Custom %" step="0.1" min="0.01" max="50" oninput="setSlipCustom(this.value)">
    <button class="s-done" onclick="closeModal('sModal')">âœ“ Done</button>
  </div>
</div>

<!-- â•â• TOKEN PICKER â•â• -->
<div class="overlay" id="tkModal">
  <div class="tkmodal-box">
    <div class="tksearch">
      <div class="tksearch-title">Select Token</div>
      <input class="tkinp" id="tkInp" type="text" placeholder="Search name or symbol..." oninput="filterTk()">
    </div>
    <div class="tklist" id="tkList"></div>
  </div>
</div>

<!-- â•â• TOAST â•â• -->
<div class="toast" id="toast"></div>

<!-- â•â• NAV â•â• -->
<nav>
  <div class="logo">Rialo<small>Swap</small></div>
  <div class="navlinks">
    <a class="on">Swap</a>
    <a>Liquidity</a>
    <a>Analytics</a>
    <a>Portfolio</a>
  </div>
  <div class="navr">
    <div class="nbadge"><div class="ndot"></div>SOLANA</div>
    <button id="cwBtn" onclick="openWalletModal()">ğŸ”— Connect Wallet</button>
  </div>
</nav>

<main>

  <!-- LEFT: PAIR LIST -->
  <div class="card tpairs">
    <div class="ch">Markets</div>
    <div id="pairList"></div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div class="stats">
      <div class="stat">
        <div class="sl">SOL Price</div>
        <div class="sv" id="sPrice">$--</div>
        <div class="ss" id="sChg">--</div>
      </div>
      <div class="stat">
        <div class="sl">24h Volume</div>
        <div class="sv" id="sVol">$--</div>
        <div class="ss" style="color:var(--muted)">Solana DEX</div>
      </div>
      <div class="stat">
        <div class="sl">Market Cap</div>
        <div class="sv" id="sMkt">$--</div>
        <div class="ss" style="color:var(--muted)">Circulating</div>
      </div>
      <div class="stat">
        <div class="sl">Network TPS</div>
        <div class="sv" id="sTps">--</div>
        <div class="ss" style="color:var(--muted)">tx/sec</div>
      </div>
    </div>

    <div class="card cchart">
      <div class="ctop">
        <div class="plogos">
          <div class="coin-icon" id="pIcon1">â—</div>
          <div class="coin-icon" id="pIcon2">â‚®</div>
        </div>
        <span class="pnm" id="pairName">SOL / USDT</span>
        <div class="ppw">
          <span class="lp" id="liveP">$--</span>
          <span class="lc" id="liveC">--</span>
        </div>
        <div class="tfs">
          <button class="tf on" onclick="setTF(this,60)">1m</button>
          <button class="tf" onclick="setTF(this,300)">5m</button>
          <button class="tf" onclick="setTF(this,900)">15m</button>
          <button class="tf" onclick="setTF(this,3600)">1h</button>
          <button class="tf" onclick="setTF(this,14400)">4h</button>
          <button class="tf" onclick="setTF(this,86400)">1d</button>
        </div>
      </div>
      <div id="chartDiv"></div>
      <div class="inds">
        <div class="ind"><span class="ind-l">RSI(14)</span><span class="ind-v" id="iRsi" style="color:#f0a500">--</span></div>
        <div class="ind"><span class="ind-l">MACD</span><span class="ind-v" id="iMacd">--</span></div>
        <div class="ind"><span class="ind-l">Vol 24h</span><span class="ind-v g" id="iVol">--</span></div>
        <div class="ind"><span class="ind-l">Mkt Cap</span><span class="ind-v g" id="iMkt">--</span></div>
      </div>
    </div>

    <div class="card">
      <div class="ch">Recent Trades</div>
      <div class="tcols">
        <span>Type</span><span>Price (USDT)</span><span>Amount</span><span>Time</span>
      </div>
      <div id="tradeList"></div>
    </div>
  </div>

  <!-- RIGHT: SWAP -->
  <div class="right">
    <div class="swapcard">
      <div class="swap-header">
        <div class="swap-title">Advanced Swap</div>
        <button class="slip-btn-sm" onclick="openModal('sModal')">
          âš™ <span id="slipDisp">0.5%</span> slippage
        </button>
      </div>
      <div class="swap-body">

        <!-- You Pay -->
        <div class="tbox">
          <div class="tbox-top">
            <span class="tbox-lbl">You Pay</span>
            <span class="tbox-bal" id="inBal" onclick="setMax()">Balance: --</span>
          </div>
          <div class="tbox-row">
            <div class="tk-sel" onclick="openTkModal('in')">
              <div class="tk-icon" id="inIcon">â—</div>
              <span class="tk-sym" id="inSym">SOL</span>
              <span class="tk-chev">â–¾</span>
            </div>
            <input class="amt-inp" id="inAmt" type="number" placeholder="0.00" oninput="onInput()" min="0">
          </div>
          <div class="amt-usd" id="inUsd">â‰ˆ $0.00</div>
        </div>

        <!-- Flip -->
        <div class="flip-wrap">
          <div class="flip-btn" onclick="flipTokens()" title="Flip tokens">â‡…</div>
        </div>

        <!-- You Receive -->
        <div class="tbox">
          <div class="tbox-top">
            <span class="tbox-lbl">You Receive</span>
            <span class="tbox-bal" id="outBal">Balance: --</span>
          </div>
          <div class="tbox-row">
            <div class="tk-sel" onclick="openTkModal('out')">
              <div class="tk-icon" id="outIcon">ğŸ’µ</div>
              <span class="tk-sym" id="outSym">USDC</span>
              <span class="tk-chev">â–¾</span>
            </div>
            <input class="amt-inp" id="outAmt" type="text" placeholder="0.00" readonly>
          </div>
          <div class="amt-usd" id="outUsd">â‰ˆ $0.00</div>
        </div>

        <!-- Route Info -->
        <div class="route-box" id="routeBox">
          <div class="route-row"><span class="rl">Rate</span><span class="rv" id="rRate">--</span></div>
          <div class="route-row"><span class="rl">Price Impact</span><span class="rv" id="rImpact">--</span></div>
          <div class="route-row"><span class="rl">Min Received</span><span class="rv" id="rMin">--</span></div>
          <div class="route-row"><span class="rl">Network Fee</span><span class="rv g">~0.000005 SOL</span></div>
          <div class="route-row" style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(0,220,180,0.08)">
            <span class="rl">Route</span>
            <div class="rpath" id="rPath"></div>
          </div>
        </div>

        <!-- THE BUTTON -->
        <button class="swap-btn s-connect" id="swapBtn" onclick="handleBtn()">
          ğŸ”— Connect Wallet
        </button>

      </div>
    </div>
  </div>

</main>

<footer>Powered by <b>RialoSwap</b> Â· Built on <b>Solana</b> Â· Aggregated via Solana Liquidity Protocol</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RPC = 'https://mainnet.helius-rpc.com/?api-key=0f157c08-0320-4aeb-9db1-3dfeaccb38fd';
const JUP = 'https://quote-api.jup.ag/v6';

// â”€â”€â”€ Token list with emoji fallback icons â”€â”€â”€
const TOKENS = [
  { sym:'SOL',  name:'Solana',           mint:'So11111111111111111111111111111111111111112',      dec:9,  icon:'â—',  color:'#9945FF' },
  { sym:'USDC', name:'USD Coin',          mint:'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',  dec:6,  icon:'ğŸ’µ', color:'#2775CA' },
  { sym:'USDT', name:'Tether USD',        mint:'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB',  dec:6,  icon:'â‚®',  color:'#26A17B' },
  { sym:'BONK', name:'Bonk',              mint:'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263', dec:5,  icon:'ğŸ•', color:'#F5841F' },
  { sym:'WIF',  name:'dogwifhat',         mint:'EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm', dec:6,  icon:'ğŸ¶', color:'#C5860D' },
  { sym:'RAY',  name:'Raydium',           mint:'4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R', dec:6,  icon:'âš¡', color:'#00B2FF' },
  { sym:'ORCA', name:'Orca',              mint:'orcaEKTdK7LKz57vaAYr9QeNsVEPfiu6QeMU1kektZE',  dec:6,  icon:'ğŸ‹', color:'#F9D449' },
  { sym:'JTO',  name:'Jito',              mint:'jtojtomepa8beP8AuQc6eXt5FriJwfFMwjx2v9iZpSej', dec:9,  icon:'ğŸŒŠ', color:'#38BDF8' },
  { sym:'mSOL', name:'Marinade SOL',      mint:'mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So', dec:9,  icon:'ğŸŒŠ', color:'#00A3FF' },
  { sym:'PYTH', name:'Pyth Network',      mint:'HZ1JovNiVvGrGNiiYvEozEVgZ58xaU3RKwX8eACQBCt3', dec:6, icon:'ğŸ”®', color:'#8B5CF6' },
];

// â”€â”€â”€ Market pairs â”€â”€â”€
const MARKET_PAIRS = [
  { binance:'SOLUSDT',  sym:'SOL',  pair:'SOL/USDT',  icon:'â—' },
  { binance:'BTCUSDT',  sym:'BTC',  pair:'BTC/USDT',  icon:'â‚¿' },
  { binance:'ETHUSDT',  sym:'ETH',  pair:'ETH/USDT',  icon:'Î' },
  { binance:'WIFUSDT',  sym:'WIF',  pair:'WIF/USDT',  icon:'ğŸ¶' },
  { binance:'BONKUSDT', sym:'BONK', pair:'BONK/USDT', icon:'ğŸ•' },
];

// â”€â”€â”€ State â”€â”€â”€
let walletConnected = false;
let walletPubkey    = null;
let walletProvider  = null;
let slippageBps     = 50;
let inToken         = TOKENS[0];
let outToken        = TOKENS[1];
let currentQuote    = null;
let quoteTimer      = null;
let currentPrice    = 0;
let tkTarget        = 'in';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id)  { document.getElementById(id).classList.add('show') }
function closeModal(id) { document.getElementById(id).classList.remove('show') }

// Close modal when clicking outside
document.querySelectorAll('.overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('show'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WALLET DETECTION + CONNECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openWalletModal() {
  // Detect installed wallets
  detectWallets();
  openModal('wModal');
}

function detectWallets() {
  const set = (id, installed) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = installed ? 'Installed' : 'Not installed';
    el.className = 'w-status' + (installed ? '' : ' na');
  };
  set('phantomStatus',  !!window.solana?.isPhantom || !!window.phantom?.solana?.isPhantom);
  set('solflareStatus', !!window.solflare?.isSolflare);
  set('backpackStatus', !!window.backpack?.solana || !!window.xnft?.solana);
  set('trustStatus',    !!window.trustwallet?.solana || !!window.solana?.isTrust);
}

async function doConnect(walletName) {
  closeModal('wModal');
  showToast('Connecting to ' + walletName + '...');

  try {
    let pubkey = null;
    let provider = null;

    if (walletName === 'phantom') {
      // Phantom â€” window.phantom.solana (new) OR window.solana (legacy)
      const ph = window.phantom?.solana || window.solana;
      if (!ph?.isPhantom) {
        showToast('Phantom not installed. Install from phantom.app', true);
        return;
      }
      const resp = await ph.connect();
      pubkey   = resp.publicKey.toString();
      provider = ph;

    } else if (walletName === 'solflare') {
      const sf = window.solflare;
      if (!sf?.isSolflare) {
        showToast('Solflare not installed. Install from solflare.com', true);
        return;
      }
      await sf.connect();
      pubkey   = sf.publicKey.toString();
      provider = sf;

    } else if (walletName === 'backpack') {
      const bp = window.backpack?.solana || window.xnft?.solana;
      if (!bp) {
        showToast('Backpack not installed. Install from backpack.app', true);
        return;
      }
      const resp = await bp.connect();
      pubkey   = resp.publicKey.toString();
      provider = bp;

    } else if (walletName === 'trust') {
      const tw = window.trustwallet?.solana || (window.solana?.isTrust ? window.solana : null);
      if (!tw) {
        showToast('Trust Wallet not installed. Install the app', true);
        return;
      }
      const resp = await tw.connect();
      pubkey   = resp.publicKey.toString();
      provider = tw;
    }

    if (!pubkey) throw new Error('No public key returned');

    // âœ“ Connected
    walletConnected = true;
    walletPubkey    = pubkey;
    walletProvider  = provider;

    const short = pubkey.slice(0,4) + '...' + pubkey.slice(-4);
    const btn = document.getElementById('cwBtn');
    btn.textContent = 'â— ' + short;
    btn.classList.add('connected');

    showToast('âœ“ Connected: ' + short);
    refreshBtn();
    loadBalances();

    // Listen for wallet disconnect/account change
    provider.on?.('disconnect', () => onWalletDisconnect());
    provider.on?.('accountChanged', () => onWalletDisconnect());

  } catch(e) {
    const msg = e.message?.toLowerCase();
    if (msg?.includes('user rejected') || msg?.includes('cancelled') || msg?.includes('denied')) {
      showToast('Connection cancelled by user', true);
    } else {
      showToast('Connection failed: ' + (e.message || 'Unknown error'), true);
    }
  }
}

function onWalletDisconnect() {
  walletConnected = false;
  walletPubkey    = null;
  walletProvider  = null;
  const btn = document.getElementById('cwBtn');
  btn.textContent = 'ğŸ”— Connect Wallet';
  btn.className   = '';
  btn.onclick     = () => openWalletModal();
  document.getElementById('inBal').textContent  = 'Balance: --';
  document.getElementById('outBal').textContent = 'Balance: --';
  refreshBtn();
  showToast('Wallet disconnected');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BALANCES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBalances() {
  if (!walletPubkey) return;
  const [ib, ob] = await Promise.all([getBalance(inToken), getBalance(outToken)]);
  document.getElementById('inBal').textContent  = ib  !== null ? `Balance: ${ib} ${inToken.sym}`  : 'Balance: --';
  document.getElementById('outBal').textContent = ob !== null ? `Balance: ${ob} ${outToken.sym}` : 'Balance: --';
}

async function getBalance(token) {
  if (!walletPubkey) return null;
  try {
    const conn = new solanaWeb3.Connection(RPC, 'confirmed');
    if (token.sym === 'SOL') {
      const lam = await conn.getBalance(new solanaWeb3.PublicKey(walletPubkey));
      return (lam / 1e9).toFixed(4);
    }
    const accounts = await conn.getParsedTokenAccountsByOwner(
      new solanaWeb3.PublicKey(walletPubkey),
      { mint: new solanaWeb3.PublicKey(token.mint) }
    );
    if (!accounts.value.length) return '0.0000';
    return parseFloat(accounts.value[0].account.data.parsed.info.tokenAmount.uiAmountString).toFixed(4);
  } catch { return null; }
}

async function setMax() {
  if (!walletConnected) { openWalletModal(); return; }
  const bal = await getBalance(inToken);
  if (!bal) return;
  let v = parseFloat(bal);
  if (inToken.sym === 'SOL') v = Math.max(0, v - 0.01);
  if (v <= 0) return;
  document.getElementById('inAmt').value = v.toFixed(6);
  onInput();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SLIPPAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSlip(pct, btn) {
  slippageBps = Math.round(pct * 100);
  document.getElementById('slipDisp').textContent = pct + '%';
  document.querySelectorAll('.s-opt').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  if (currentQuote) fetchQuote();
}
function setSlipCustom(val) {
  const v = parseFloat(val);
  if (v > 0 && v <= 50) {
    slippageBps = Math.round(v * 100);
    document.getElementById('slipDisp').textContent = v + '%';
    document.querySelectorAll('.s-opt').forEach(b => b.classList.remove('on'));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN PICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTkModal(target) {
  tkTarget = target;
  document.getElementById('tkInp').value = '';
  renderTkList(TOKENS);
  openModal('tkModal');
}

function filterTk() {
  const q = document.getElementById('tkInp').value.toLowerCase();
  renderTkList(q ? TOKENS.filter(t => t.sym.toLowerCase().includes(q) || t.name.toLowerCase().includes(q)) : TOKENS);
}

function renderTkList(list) {
  const cur = tkTarget === 'in' ? inToken : outToken;
  document.getElementById('tkList').innerHTML = list.map(tk => `
    <div class="tkitem ${tk.sym === cur.sym ? 'sel' : ''}" onclick="selectTk('${tk.sym}')">
      <div class="tk-icon" style="background:${tk.color}22;color:${tk.color}">${tk.icon}</div>
      <div>
        <div class="tkitem-sym">${tk.sym}</div>
        <div class="tkitem-name">${tk.name}</div>
      </div>
    </div>`).join('');
}

function selectTk(sym) {
  const tk = TOKENS.find(t => t.sym === sym);
  if (!tk) return;
  closeModal('tkModal');

  if (tkTarget === 'in') {
    if (tk.sym === outToken.sym) { flipTokens(); return; }
    inToken = tk;
    document.getElementById('inIcon').textContent = tk.icon;
    document.getElementById('inIcon').style.cssText = `background:${tk.color}22;color:${tk.color}`;
    document.getElementById('inSym').textContent  = tk.sym;
  } else {
    if (tk.sym === inToken.sym) { flipTokens(); return; }
    outToken = tk;
    document.getElementById('outIcon').textContent = tk.icon;
    document.getElementById('outIcon').style.cssText = `background:${tk.color}22;color:${tk.color}`;
    document.getElementById('outSym').textContent  = tk.sym;
  }
  document.getElementById('inAmt').value  = '';
  document.getElementById('outAmt').value = '';
  clearRoute();
  refreshBtn();
  loadBalances();
}

function flipTokens() {
  [inToken, outToken] = [outToken, inToken];

  document.getElementById('inIcon').textContent = inToken.icon;
  document.getElementById('inIcon').style.cssText = `background:${inToken.color}22;color:${inToken.color}`;
  document.getElementById('inSym').textContent  = inToken.sym;
  document.getElementById('outIcon').textContent = outToken.icon;
  document.getElementById('outIcon').style.cssText = `background:${outToken.color}22;color:${outToken.color}`;
  document.getElementById('outSym').textContent  = outToken.sym;

  const prev = document.getElementById('outAmt').value;
  document.getElementById('inAmt').value  = prev || '';
  document.getElementById('outAmt').value = '';
  clearRoute();
  loadBalances();
  if (document.getElementById('inAmt').value) onInput(); else refreshBtn();
}

// Initialize token icons on load
function initTokenIcons() {
  document.getElementById('inIcon').textContent = inToken.icon;
  document.getElementById('inIcon').style.cssText = `background:${inToken.color}22;color:${inToken.color}`;
  document.getElementById('outIcon').textContent = outToken.icon;
  document.getElementById('outIcon').style.cssText = `background:${outToken.color}22;color:${outToken.color}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUOTE â€” Jupiter API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onInput() {
  clearTimeout(quoteTimer);
  const v = parseFloat(document.getElementById('inAmt').value);
  if (!v || v <= 0) {
    document.getElementById('outAmt').value = '';
    clearRoute();
    refreshBtn();
    return;
  }
  if (inToken.sym === 'SOL' && currentPrice)
    document.getElementById('inUsd').textContent = 'â‰ˆ $' + (v * currentPrice).toFixed(2);
  refreshBtn('loading');
  quoteTimer = setTimeout(fetchQuote, 650);
}

async function fetchQuote() {
  const v = parseFloat(document.getElementById('inAmt').value);
  if (!v || v <= 0) return;
  const amtRaw = Math.floor(v * Math.pow(10, inToken.dec));
  try {
    const url = `${JUP}/quote?inputMint=${inToken.mint}&outputMint=${outToken.mint}&amount=${amtRaw}&slippageBps=${slippageBps}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Quote ' + res.status);
    const q = await res.json();
    if (q.error) throw new Error(q.error);
    currentQuote = q;

    const outAmt = parseInt(q.outAmount) / Math.pow(10, outToken.dec);
    const minAmt = parseInt(q.otherAmountThreshold) / Math.pow(10, outToken.dec);
    const impact = parseFloat(q.priceImpactPct || 0) * 100;
    const rate   = (outAmt / v).toFixed(Math.min(outToken.dec, 4));

    document.getElementById('outAmt').value = outAmt.toFixed(Math.min(outToken.dec, 6));
    document.getElementById('inUsd').textContent  = inToken.sym  === 'SOL' && currentPrice ? 'â‰ˆ $'+(v*currentPrice).toFixed(2) : '';
    document.getElementById('outUsd').textContent = outToken.sym === 'SOL' && currentPrice ? 'â‰ˆ $'+(outAmt*currentPrice).toFixed(2) : '';
    document.getElementById('rRate').textContent   = `1 ${inToken.sym} = ${rate} ${outToken.sym}`;
    document.getElementById('rMin').textContent    = minAmt.toFixed(Math.min(outToken.dec,4)) + ' ' + outToken.sym;
    document.getElementById('rImpact').textContent = impact.toFixed(3) + '%';
    document.getElementById('rImpact').className   = 'rv ' + (impact < 0.5 ? 'g' : impact < 2 ? 'w' : 'r');

    const pathEl = document.getElementById('rPath');
    pathEl.innerHTML = `<span class="hop">${inToken.sym}</span>`;
    (q.routePlan || []).forEach(r => {
      const mint = r.swapInfo?.outputMint;
      const found = TOKENS.find(t => t.mint === mint);
      pathEl.innerHTML += `<span style="color:var(--muted);margin:0 2px;font-size:0.7rem">â†’</span><span class="hop">${found ? found.sym : (mint?.slice(0,4)+'...')}</span>`;
    });

    document.getElementById('routeBox').style.display = 'block';
    refreshBtn('ready');
  } catch(e) {
    console.error('Quote error:', e);
    currentQuote = null;
    clearRoute();
    refreshBtn('error');
  }
}

function clearRoute() {
  currentQuote = null;
  document.getElementById('routeBox').style.display = 'none';
  document.getElementById('outAmt').value = '';
  document.getElementById('inUsd').textContent  = 'â‰ˆ $0.00';
  document.getElementById('outUsd').textContent = 'â‰ˆ $0.00';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUTTON STATE MACHINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshBtn(state) {
  const btn = document.getElementById('swapBtn');
  btn.className = 'swap-btn';
  const amt = parseFloat(document.getElementById('inAmt').value);

  if (!walletConnected) {
    btn.classList.add('s-connect');
    btn.innerHTML = 'ğŸ”— Connect Wallet';
  } else if (state === 'loading') {
    btn.classList.add('s-loading');
    btn.innerHTML = '<span class="spin"></span>Getting best route...';
  } else if (state === 'ready') {
    btn.classList.add('s-ready');
    btn.textContent = `Swap ${inToken.sym} â†’ ${outToken.sym}`;
  } else if (state === 'error') {
    btn.classList.add('s-err');
    btn.textContent = 'Quote failed â€” try again';
  } else {
    btn.classList.add('s-enter');
    btn.textContent = 'Enter an amount';
  }
}

function handleBtn() {
  if (!walletConnected) { openWalletModal(); return; }
  if (!currentQuote) return;
  executeSwap();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXECUTE SWAP â€” Real Solana Transaction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function executeSwap() {
  if (!walletProvider || !walletPubkey || !currentQuote) return;

  const btn = document.getElementById('swapBtn');
  const setLoading = (msg) => {
    btn.className = 'swap-btn s-loading';
    btn.innerHTML = `<span class="spin"></span>${msg}`;
  };

  setLoading('Preparing transaction...');
  try {
    // Step 1: Get swap transaction from Jupiter
    const swapRes = await fetch(`${JUP}/swap`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        quoteResponse: currentQuote,
        userPublicKey: walletPubkey,
        wrapAndUnwrapSol: true,
        dynamicComputeUnitLimit: true,
        prioritizationFeeLamports: 'auto',
      })
    });
    if (!swapRes.ok) {
      const err = await swapRes.json().catch(() => ({}));
      throw new Error(err.error || 'Swap API error ' + swapRes.status);
    }
    const { swapTransaction } = await swapRes.json();

    // Step 2: Deserialize & sign
    setLoading('Awaiting wallet approval...');
    const conn   = new solanaWeb3.Connection(RPC, { commitment:'confirmed', confirmTransactionInitialTimeout:120000 });
    const txBuf  = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));
    const tx     = solanaWeb3.VersionedTransaction.deserialize(txBuf);
    const signed = await walletProvider.signTransaction(tx);

    // Step 3: Broadcast
    setLoading('Broadcasting to Solana...');
    const txid = await conn.sendRawTransaction(signed.serialize(), { skipPreflight:true, maxRetries:3 });

    // Step 4: Confirm
    setLoading('Confirming on-chain...');
    const { blockhash, lastValidBlockHeight } = await conn.getLatestBlockhash();
    const result = await conn.confirmTransaction({ blockhash, lastValidBlockHeight, signature:txid }, 'confirmed');
    if (result.value.err) throw new Error('Transaction reverted on-chain');

    // âœ“ Success
    showToast(`âœ“ Swap successful!\nTx: ${txid.slice(0,8)}...${txid.slice(-6)}`);
    setTimeout(() => window.open(`https://solscan.io/tx/${txid}`, '_blank'), 800);

    document.getElementById('inAmt').value  = '';
    document.getElementById('outAmt').value = '';
    clearRoute();
    refreshBtn();
    loadBalances();

  } catch(e) {
    console.error('Swap error:', e);
    const rejected = e.message?.toLowerCase().match(/reject|cancel|denied|user/);
    showToast((rejected ? 'âš  Transaction rejected' : 'âš  ' + (e.message || 'Swap failed')), true);
    refreshBtn('ready');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE PRICES â€” Binance API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPrices() {
  try {
    const symbols = encodeURIComponent(JSON.stringify(MARKET_PAIRS.map(p => p.binance)));
    const res  = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbols=${symbols}`);
    if (!res.ok) throw new Error('Binance ' + res.status);
    const data = await res.json();

    const pEl = document.getElementById('pairList');
    pEl.innerHTML = '';

    data.forEach((ticker, i) => {
      const pair = MARKET_PAIRS.find(p => p.binance === ticker.symbol);
      if (!pair) return;
      const p   = parseFloat(ticker.lastPrice);
      const ch  = parseFloat(ticker.priceChangePercent);
      const pos = ch >= 0;
      const fmt = p > 1000 ? '$'+(p/1000).toFixed(2)+'k' : p > 1 ? '$'+p.toFixed(2) : '$'+p.toFixed(6);

      if (pair.sym === 'SOL') {
        currentPrice = p;
        document.getElementById('sPrice').textContent = '$' + p.toFixed(2);
        document.getElementById('sChg').textContent   = (pos?'+':'')+ch.toFixed(2)+'%';
        document.getElementById('sChg').style.color   = pos ? 'var(--accent)' : 'var(--red)';
        document.getElementById('liveP').textContent  = '$' + p.toFixed(2);
        document.getElementById('liveC').textContent  = (pos?'+':'')+ch.toFixed(2)+'%';
        document.getElementById('liveC').style.color  = pos ? 'var(--accent)' : 'var(--red)';
        const vol = parseFloat(ticker.quoteVolume);
        document.getElementById('sVol').textContent = '$'+(vol/1e9).toFixed(1)+'B';
        document.getElementById('iVol').textContent = '$'+(vol/1e9).toFixed(1)+'B';
        document.getElementById('sMkt').textContent = '$'+(p*5.8e8/1e9).toFixed(1)+'B';
        document.getElementById('iMkt').textContent = '$'+(p*5.8e8/1e9).toFixed(1)+'B';
        document.getElementById('iRsi').textContent = (40+Math.random()*20).toFixed(1);
        const mv = ((Math.random()-0.5)*2).toFixed(2);
        document.getElementById('iMacd').textContent = mv;
        document.getElementById('iMacd').style.color = mv > 0 ? 'var(--accent)' : 'var(--red)';
        document.getElementById('sTps').textContent  = (2800+Math.floor(Math.random()*400)).toLocaleString();
        if (!chart) initChart(p);
      }

      pEl.innerHTML += `
        <div class="titem ${i===0?'on':''}" onclick="selPair(this,'${pair.pair}','${pair.icon}')">
          <div class="coin-icon">${pair.icon}</div>
          <div class="tii">
            <div class="tis">${pair.pair}</div>
            <div class="tip ${pos?'g':'rr'}">${fmt}</div>
            <div class="tic ${pos?'g':'rr'}">${pos?'+':''}${ch.toFixed(2)}%</div>
          </div>
        </div>`;
    });
  } catch(e) {
    console.error('Price fetch:', e);
    if (!currentPrice && !chart) { currentPrice = 150; initChart(150); }
  }
}

function selPair(el, pair, icon) {
  document.querySelectorAll('.titem').forEach(r => r.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('pairName').textContent = pair;
  document.getElementById('pIcon1').textContent   = icon;
}

// Binance WebSocket â€” real-time SOL price
function startPriceTick() {
  try {
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/solusdt@miniTicker');
    ws.onmessage = e => {
      const d = JSON.parse(e.data);
      const p = parseFloat(d.c);
      if (!p) return;
      currentPrice = p;
      document.getElementById('sPrice').textContent = '$' + p.toFixed(2);
      document.getElementById('liveP').textContent  = '$' + p.toFixed(2);
    };
    ws.onclose = () => setTimeout(startPriceTick, 3000);
    ws.onerror = () => {};
  } catch(e) {}
}

fetchPrices();
setInterval(fetchPrices, 12000);
startPriceTick();
setInterval(() => {
  if (currentQuote && document.getElementById('inAmt').value) fetchQuote();
}, 25000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE TRADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addTrade() {
  const buy = Math.random() > 0.5;
  const p   = currentPrice ? (currentPrice+(Math.random()-0.5)*0.4).toFixed(3) : '150.00';
  const a   = (0.1+Math.random()*8).toFixed(2);
  const now = new Date();
  const t   = [now.getHours(),now.getMinutes(),now.getSeconds()].map(n=>String(n).padStart(2,'0')).join(':');
  const list = document.getElementById('tradeList');
  const row  = document.createElement('div');
  row.className = 'trow';
  row.innerHTML = `<span class="${buy?'g':'rr'}">${buy?'BUY':'SELL'}</span><span class="${buy?'g':'rr'}">${p}</span><span>${a}</span><span style="color:var(--muted)">${t}</span>`;
  list.insertBefore(row, list.firstChild);
  if (list.children.length > 14) list.removeChild(list.lastChild);
}
for(let i=0;i<8;i++) addTrade();
setInterval(addTrade, 1600);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART â€” Binance Kline WebSocket
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chart, cs, candles = [], currentTF = '1m', klineWs = null;

function initChart(base) {
  const el = document.getElementById('chartDiv');
  if (!el) return;
  if (chart) { try { chart.remove(); } catch(e) {} chart = null; }

  chart = LightweightCharts.createChart(el, {
    width: el.clientWidth, height: 290,
    layout: { background:{color:'#0d1520'}, textColor:'#dff0ec' },
    grid:   { vertLines:{color:'rgba(0,220,180,0.05)'}, horzLines:{color:'rgba(0,220,180,0.05)'} },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    rightPriceScale: { borderColor:'rgba(0,220,180,0.15)' },
    timeScale: { borderColor:'rgba(0,220,180,0.15)', timeVisible:true, secondsVisible:false },
  });
  cs = chart.addCandlestickSeries({
    upColor:'#00dcb4',   downColor:'#ff4560',
    borderUpColor:'#00dcb4', borderDownColor:'#ff4560',
    wickUpColor:'#00dcb4',   wickDownColor:'#ff4560',
  });
  new ResizeObserver(() => { if(chart&&el) chart.applyOptions({width:el.clientWidth}) }).observe(el);
  loadKlines(currentTF);
}

async function loadKlines(interval) {
  try {
    const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=SOLUSDT&interval=${interval}&limit=200`);
    if (!res.ok) throw new Error();
    const raw = await res.json();
    candles = raw.map(k => ({
      time:Math.floor(k[0]/1000), open:+k[1], high:+k[2], low:+k[3], close:+k[4]
    }));
    cs.setData(candles);
    chart.timeScale().fitContent();
    startKlineWs(interval);
  } catch(e) { console.error('Kline error:', e); }
}

function startKlineWs(interval) {
  if (klineWs) { try { klineWs.close(); } catch(e) {} klineWs = null; }
  try {
    klineWs = new WebSocket(`wss://stream.binance.com:9443/ws/solusdt@kline_${interval}`);
    klineWs.onmessage = e => {
      const k = JSON.parse(e.data).k;
      const bar = { time:Math.floor(k.t/1000), open:+k.o, high:+k.h, low:+k.l, close:+k.c };
      if (candles.length && candles[candles.length-1].time === bar.time) {
        candles[candles.length-1] = bar;
      } else {
        candles.push(bar);
        if (candles.length > 300) candles.shift();
      }
      if (cs) cs.update(bar);
    };
    klineWs.onclose = () => setTimeout(() => startKlineWs(interval), 3000);
    klineWs.onerror = () => {};
  } catch(e) {}
}

function setTF(btn, sec) {
  document.querySelectorAll('.tf').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  const map = {60:'1m',300:'5m',900:'15m',3600:'1h',14400:'4h',86400:'1d'};
  currentTF = map[sec] || '1m';
  candles = [];
  if (cs) cs.setData([]);
  loadKlines(currentTF);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, isErr=false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast' + (isErr ? ' err' : '');
  void el.offsetWidth;
  el.classList.add('show');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('show'), 4500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initTokenIcons();
refreshBtn();
</script>
</body>
</html>
